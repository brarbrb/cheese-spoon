{% extends 'base.html' %}

{% block title %}Set Filters{% endblock %}

{% block head %}
<style>
    .importance-selector {
      display: flex;
      gap: 0;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #dee2e6;
    }

    .importance-btn {
      width: 34px;
      height: 34px;
      border: none;
      border-right: 1px solid #dee2e6;
      background: white;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.85rem;
    }

    .importance-btn:hover {
      border-color: #007bff;
      background: #f8f9fa;
    }

    .importance-btn:last-child {
      border-right: none;
    }

    .importance-btn.active {
      background: #007bff;
      color: white;
      transform: none;
    }

    .weight-result {
      font-size: 0.75rem;
      margin-left: 0;
      display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">

    <div class="feature-card p-4">
      <h4 class="mb-1">Set Your Preferences & Filters</h4>
      <div class="muted small mb-4">
        Step 3 of 3: Configure filters and ranking weights for personalized recommendations.
        <br><strong>{{ confirmed_count }}</strong> courses confirmed from your grade sheet.
      </div>

      <form method="POST" id="filtersForm">
        <div class="form-group">
          <label class="mb-1"><strong>Semester</strong></label>
          <select class="form-control" name="semester">
            <option value="WINTER_2025_2026" selected>Winter 2025/2026</option>
            <option value="SPRING_2026">Spring 2026</option>
            <option value="FALL_2025">Fall 2025</option>
          </select>
        </div>

        <hr>

        <h5 class="mb-3">Course Filters</h5>

        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="mb-1"><strong>Exam requirement</strong></label>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="noExamCheck" name="no_exam" value="true">
              <label class="custom-control-label" for="noExamCheck">
                Only show courses without exams
              </label>
            </div>
          </div>

          <div class="form-group col-md-6">
            <label class="mb-1"><strong>Minimum credits</strong></label>
            <div class="d-flex align-items-center">
              <input
                type="range"
                class="custom-range flex-grow-1"
                id="minCreditsSlider"
                name="min_credits"
                min="0"
                max="5"
                step="0.5"
                value="0"
              >
              <span class="ml-3" id="minCreditsValue">0.0</span>
            </div>
          </div>
        </div>

        <hr>

        <h5 class="mb-2">Ranking Preferences</h5>
        <div class="muted small mb-3">
          Rate the importance of each factor from 1 (not important) to 5 (very important)
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="mb-2"><strong>Match to Your Query</strong></label>
              <div class="d-flex align-items-center">
                <div class="importance-selector" data-param="semantic">
                  <button type="button" class="importance-btn" data-value="1">1</button>
                  <button type="button" class="importance-btn" data-value="2">2</button>
                  <button type="button" class="importance-btn active" data-value="3">3</button>
                  <button type="button" class="importance-btn" data-value="4">4</button>
                  <button type="button" class="importance-btn" data-value="5">5</button>
                </div>
                <span class="weight-result ml-3">
                  Weight: <strong class="weight-value">0.20</strong>
                </span>
              </div>
              <input type="hidden" name="semantic_importance" value="2">
              <input type="hidden" name="semantic_weight" value="0.20">
            </div>

            <div class="form-group">
              <label class="mb-2"><strong>Number of Credits</strong></label>
              <div class="d-flex align-items-center">
                <div class="importance-selector" data-param="credits">
                  <button type="button" class="importance-btn" data-value="1">1</button>
                  <button type="button" class="importance-btn" data-value="2">2</button>
                  <button type="button" class="importance-btn active" data-value="3">3</button>
                  <button type="button" class="importance-btn" data-value="4">4</button>
                  <button type="button" class="importance-btn" data-value="5">5</button>
                </div>
                <span class="weight-result ml-3">
                  Weight: <strong class="weight-value">0.20</strong>
                </span>
              </div>
              <input type="hidden" name="credits_importance" value="2">
              <input type="hidden" name="credits_weight" value="0.20">
            </div>

            <div class="form-group">
              <label class="mb-2"><strong>High Average Grade</strong></label>
              <div class="d-flex align-items-center">
                <div class="importance-selector" data-param="avg_grade">
                  <button type="button" class="importance-btn" data-value="1">1</button>
                  <button type="button" class="importance-btn" data-value="2">2</button>
                  <button type="button" class="importance-btn active" data-value="3">3</button>
                  <button type="button" class="importance-btn" data-value="4">4</button>
                  <button type="button" class="importance-btn" data-value="5">5</button>
                </div>
                <span class="weight-result ml-3">
                  Weight: <strong class="weight-value">0.20</strong>
                </span>
              </div>
              <input type="hidden" name="avg_grade_importance" value="2">
              <input type="hidden" name="avg_grade_weight" value="0.20">
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-group">
              <label class="mb-2"><strong>Low Workload</strong></label>
              <div class="d-flex align-items-center">
                <div class="importance-selector" data-param="workload_rating">
                  <button type="button" class="importance-btn" data-value="1">1</button>
                  <button type="button" class="importance-btn" data-value="2">2</button>
                  <button type="button" class="importance-btn active" data-value="3">3</button>
                  <button type="button" class="importance-btn" data-value="4">4</button>
                  <button type="button" class="importance-btn" data-value="5">5</button>
                </div>
                <span class="weight-result ml-3">
                  Weight: <strong class="weight-value">0.20</strong>
                </span>
              </div>
              <input type="hidden" name="workload_rating_importance" value="2">
              <input type="hidden" name="workload_rating_weight" value="0.20">
            </div>

            <div class="form-group">
              <label class="mb-2"><strong>High Student Rating</strong></label>
              <div class="d-flex align-items-center">
                <div class="importance-selector" data-param="general_rating">
                  <button type="button" class="importance-btn" data-value="1">1</button>
                  <button type="button" class="importance-btn" data-value="2">2</button>
                  <button type="button" class="importance-btn active" data-value="3">3</button>
                  <button type="button" class="importance-btn" data-value="4">4</button>
                  <button type="button" class="importance-btn" data-value="5">5</button>
                </div>
                <span class="weight-result ml-3">
                  Weight: <strong class="weight-value">0.20</strong>
                </span>
              </div>
              <input type="hidden" name="general_rating_importance" value="2">
              <input type="hidden" name="general_rating_weight" value="0.20">
            </div>
          </div>

          <div class="col-12">
            <div class="alert alert-light mt-3">
              <strong>Total Weight:</strong> <span id="totalWeight">1.00</span>
              <span class="muted small ml-2">(automatically normalized)</span>
            </div>
          </div>
        </div>

        <hr>

        <div class="form-group">
          <label class="mb-1"><strong>Preferences (optional)</strong></label>
          <div class="muted small mb-2">Describe your interests, goals, or constraints in natural language</div>
          <textarea class="form-control" rows="3" name="preferences_text"
            placeholder="Example: I want ML/NLP courses, moderate workload, prefer project-based courses."></textarea>
        </div>

        <div class="d-flex justify-content-between">
          <a class="btn btn-outline-secondary" href="{{ url_for('review_courses') }}">← Back to Review</a>
          <button class="btn btn-dark" type="submit">Get Recommendations →</button>
        </div>
      </form>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Min credits slider
    const minCreditsSlider = document.getElementById("minCreditsSlider");
    const minCreditsValue = document.getElementById("minCreditsValue");

    if(minCreditsSlider) {
        minCreditsSlider.addEventListener("input", () => {
          minCreditsValue.textContent = parseFloat(minCreditsSlider.value).toFixed(1);
        });
    }

    // Importance ranking system
    const importanceSelectors = document.querySelectorAll('.importance-selector');
    const totalWeightDisplay = document.getElementById('totalWeight');

    // Store current importance values
    const importanceValues = {
      semantic: 3,
      credits: 3,
      avg_grade: 3,
      workload_rating: 3,
      general_rating: 3
    };

    function normalizeWeights() {
      // Calculate total importance (shift values: 1->0, 2->1, 3->2, 4->3, 5->4)
      const adjustedValues = {};
      Object.keys(importanceValues).forEach(key => {
        adjustedValues[key] = importanceValues[key] - 1;
      });

      const total = Object.values(adjustedValues).reduce((sum, val) => sum + val, 0);

      // Normalize to weights that sum to 1.0
      const weights = {};
      Object.keys(adjustedValues).forEach(key => {
        weights[key] = total > 0 ? adjustedValues[key] / total : 0;
      });

      return weights;
    }

    function updateWeightsDisplay() {
      const weights = normalizeWeights();

      // Update each parameter's weight display and hidden input
      importanceSelectors.forEach(selector => {
        const param = selector.dataset.param;
        const weight = weights[param];

        // Update weight display
        const weightDisplay = selector.closest('.form-group').querySelector('.weight-value');
        if(weightDisplay) weightDisplay.textContent = weight.toFixed(2);

        // Update hidden weight input
        const weightInput = selector.closest('.form-group').querySelector(`input[name="${param}_weight"]`);
        if (weightInput) {
          weightInput.value = weight.toFixed(2);
        }
      });

      // Update total (should always be 1.00)
      if(totalWeightDisplay) {
         const totalWeight = Object.values(weights).reduce((sum, val) => sum + val, 0);
         totalWeightDisplay.textContent = totalWeight.toFixed(2);
      }
    }

    // Handle importance button clicks
    importanceSelectors.forEach(selector => {
      const param = selector.dataset.param;
      const buttons = selector.querySelectorAll('.importance-btn');

      buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();

          // Remove active class from all buttons in this selector
          buttons.forEach(b => b.classList.remove('active'));

          // Add active class to clicked button
          btn.classList.add('active');

          // Update importance value
          const value = parseInt(btn.dataset.value);
          importanceValues[param] = value;

          // Update hidden importance input (send adjusted value: 1->0, 2->1, etc.)
          const importanceInput = selector.closest('.form-group').querySelector(`input[name="${param}_importance"]`);
          if (importanceInput) {
            importanceInput.value = value - 1;  // Send adjusted value to backend
          }

          // Recalculate and update weights
          updateWeightsDisplay();
        });
      });
    });

    // Initialize weights on page load
    updateWeightsDisplay();
</script>
{% endblock %}