<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheeseSpoon â€” {% block title %}Course Recommender{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  {% block head %}{% endblock %}
</head>
<body>

  <nav id="top-navbar" class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <span>CheeseSpoon</span>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="brand-logo" />
      </a>

      <button class="btn btn-outline-dark d-lg-none ml-auto mr-2" data-toggle="modal" data-target="#wishlistModal">
        <i class="fas fa-shopping-cart"></i> 
        <span class="wishlist-badge badge badge-light">{{ wishlist_count }}</span>
      </button>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navContent">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="navContent" class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto align-items-lg-center">
          
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-2" href="{{ url_for('index') }}">Home</a>
          </li>

          {% if request.endpoint == 'course_overview' %}
              <li class="nav-item">
                <a class="btn btn-sm btn-primary mr-2 shadow-sm" href="{{ url_for('upload') }}">
                   <i class="fas fa-magic mr-1"></i> Personalized Recommendations
                </a>
              </li>
          {% else %}
              <li class="nav-item">
                <a class="btn btn-sm btn-outline-secondary mr-2" href="{{ url_for('course_overview') }}">
                   <i class="fas fa-search mr-1"></i> Course Overview
                </a>
              </li>
          {% endif %}

          <li class="nav-item d-none d-lg-block">
            <button class="btn btn-sm btn-dark" data-toggle="modal" data-target="#wishlistModal">
              <i class="fas fa-shopping-cart mr-1"></i> Wishlist
              <span class="wishlist-badge badge badge-light ml-1">{{ wishlist_count }}</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div id="flash-messages">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'secondary' }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {% block content %}{% endblock %}
  </main>

  <div class="modal fade" id="wishlistModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Wishlist</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        
        <div class="modal-body" id="wishlist-modal-body">
          {% if wishlist_count == 0 %}
              <div class="text-center muted py-4" id="empty-msg">Your wishlist is empty.</div>
          {% else %}
              <div class="list-group">
              {% for item in wishlist %}
                  <div class="list-group-item d-flex justify-content-between align-items-center" id="wishlist-item-{{ item.id }}">
                      <div>
                          <h6 class="mb-0">{{ item.name }}</h6>
                          <small class="text-muted">{{ item.id }} | {{ item.points }} pts</small>
                      </div>
                      <form action="{{ url_for('remove_from_wishlist') }}" method="POST" class="ajax-remove-wishlist" style="margin:0;">
                          <input type="hidden" name="course_id" value="{{ item.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                              <i class="fas fa-trash"></i>
                          </button>
                      </form>
                  </div>
              {% endfor %}
              </div>
              <div class="mt-3 text-right">
                  <strong class="mr-2">Total:</strong> <span id="wishlist-total">{{ wishlist_total }}</span> pts
              </div>
          {% endif %}
        </div>

        <div class="modal-footer">
          <form action="{{ url_for('clear_wishlist') }}" method="POST">
               <button type="submit" id="clearWishlistBtn" class="btn btn-outline-secondary" {% if wishlist_count == 0 %}disabled{% endif %} onclick="return confirm('Clear all?');">Clear</button>
          </form>
          <button type="button" class="btn btn-dark">Export PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // 1. ADD TO WISHLIST (AJAX)
    $(document).on('submit', '.ajax-add-wishlist', function(e) {
        e.preventDefault();
        const form = $(this);
        const btn = form.find('button[type="submit"]');
        
        $.ajax({
            url: "{{ url_for('add_to_wishlist') }}",
            type: "POST",
            data: form.serialize(),
            success: function(response) {
                if(response.status === 'success') {
                    // Update Badge
                    $('.wishlist-badge').text(response.count);
                    
                    // Update Button Visuals
                    btn.removeClass('btn-dark btn-outline-secondary').addClass('btn-success');
                    btn.html('<i class="fas fa-check mr-1"></i> Added');
                    btn.prop('disabled', true);
                    
                    // --- DYNAMICALLY UPDATE MODAL CONTENT ---
                    const modalBody = $('#wishlist-modal-body');
                    const courseId = form.find('input[name="course_id"]').val();
                    const courseName = form.find('input[name="course_name"]').val();
                    const coursePoints = form.find('input[name="course_points"]').val();

                    // If it was empty, create the structure
                    if(modalBody.find('#empty-msg').length > 0) {
                        modalBody.html(`
                            <div class="list-group"></div>
                            <div class="mt-3 text-right">
                                <strong class="mr-2">Total:</strong> <span id="wishlist-total">0</span> pts
                            </div>
                        `);
                        $('#clearWishlistBtn').prop('disabled', false);
                    }

                    // Append the new item
                    const newItem = `
                        <div class="list-group-item d-flex justify-content-between align-items-center" id="wishlist-item-${courseId}">
                            <div>
                                <h6 class="mb-0">${courseName}</h6>
                                <small class="text-muted">${courseId} | ${coursePoints} pts</small>
                            </div>
                            <form action="{{ url_for('remove_from_wishlist') }}" method="POST" class="ajax-remove-wishlist" style="margin:0;">
                                <input type="hidden" name="course_id" value="${courseId}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>`;
                    
                    // Only append if not already there (safety check)
                    if(modalBody.find(`#wishlist-item-${courseId}`).length === 0) {
                        modalBody.find('.list-group').append(newItem);
                    }

                    // Update total
                    $('#wishlist-total').text(response.total);
                }
            },
            error: function() { alert('Error connecting to server'); }
        });
    });

    // 2. REMOVE FROM WISHLIST (AJAX)
    $(document).on('submit', '.ajax-remove-wishlist', function(e) {
        e.preventDefault();
        const form = $(this);
        const courseId = form.find('input[name="course_id"]').val();
        
        $.ajax({
            url: "{{ url_for('remove_from_wishlist') }}",
            type: "POST",
            data: form.serialize(),
            success: function(response) {
                if(response.status === 'success') {
                    // Update Badge
                    $('.wishlist-badge').text(response.count);
                    
                    // Remove Item from Modal DOM
                    $('#wishlist-item-' + courseId).slideUp(function() { $(this).remove(); });
                    
                    // Update Total
                    $('#wishlist-total').text(response.total);
                    
                    // Handle Empty State
                    if(response.count === 0) {
                        setTimeout(() => {
                            $('#wishlist-modal-body').html('<div class="text-center muted py-4" id="empty-msg">Your wishlist is empty.</div>');
                            $('#clearWishlistBtn').prop('disabled', true);
                        }, 300); // wait for slideUp
                    }

                    // Reset the "Add" button on the main page if it exists
                    const addForm = $(`input[name="course_id"][value="${courseId}"]`).closest('.ajax-add-wishlist');
                    if(addForm.length > 0) {
                        const btn = addForm.find('button');
                        btn.removeClass('btn-success').addClass('btn-dark');
                        btn.html('Add to wishlist'); 
                        btn.prop('disabled', false);
                    }
                }
            }
        });
    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>