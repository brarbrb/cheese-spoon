<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheeseSpoon â€” Recommendations</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body>
  <nav id="top-navbar" class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <span>CheeseSpoon</span>
        <img
          src="{{ url_for('static', filename='logo.png') }}"
          alt="CheeseSpoon"
          class="brand-logo"
        />
      </a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-navbar-supported-content">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="top-navbar-supported-content" class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto align-items-lg-center">
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2"
               href="{{ url_for('index') }}">
              Home
            </a>
          </li>

          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2"
               href="{{ url_for('course_overview') }}">
              Course Overview
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row">
      <div class="col-lg-8">
        <h4 class="mb-1">Course Recommendations</h4>
        <div class="muted small mb-3">
          All eligible courses ranked by your preferences
        </div>

        <!-- Applied Filters Summary -->
        <div class="feature-card p-3 mb-3" style="height:auto; min-height:auto;">
          <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
              <div class="muted small mb-2"><strong>Applied Filters</strong></div>
              <div class="small">
                <span class="muted">Semester:</span> {{ filters.semester }}<br>
                <span class="muted">Completed courses:</span> {{ filters.completed_count }}<br>
                <span class="muted">No exam filter:</span> {{ filters.no_exam }}<br>
                <span class="muted">Min credits:</span> {{ filters.min_credits }}
              </div>
            </div>

            <div class="text-right">
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload') }}">
                Edit preferences
              </a>
            </div>
          </div>

          {% if user_query %}
          <div class="alert alert-light small mt-3 mb-0">
            <strong>Your query:</strong> {{ user_query }}
          </div>
          {% endif %}
        </div>

        <!-- Results count -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="muted small">
            Found <strong>{{ courses|length }}</strong> eligible courses
          </div>

          <div>
            <button id="showAllBtn" class="btn btn-sm btn-outline-secondary">
              Show all
            </button>
          </div>
        </div>

        <!-- Course Cards -->
        <div id="coursesList">
          {% for course in courses %}
          <div class="feature-card rec-card p-3 mb-3 course-card" data-index="{{ loop.index0 }}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center flex-wrap">
                  <span class="badge badge-secondary mr-2">#{{ loop.index }}</span>
                  <span class="kbd-pill mr-2">{{ course.ID }}</span>
                  <h5 class="mb-0">{{ course.title }}</h5>
                  <span class="muted small ml-2">({{ "%.1f"|format(course.credits) }} pts)</span>
                </div>

                <!-- Show key metadata -->
                <div class="mt-2 small">
                  <span class="muted">Avg grade:</span> {{ "%.0f"|format(course.avg_grade_all_sem) }}%
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">General rating:</span> {{ "%.1f"|format(course.general_rating) }}/5
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">Workload:</span> {{ "%.1f"|format(course.workload_rating) }}/5
                </div>
              </div>

              <div class="text-right ml-3">
                <div class="muted small">Combined Score</div>
                <div class="fit-score">{{ "%.0f"|format(course.combined_score * 100) }}%</div>
              </div>
            </div>

            <!-- Score bar -->
            <div class="fit-bar mt-2 mb-3">
              <div class="fit-bar-fill" style="width: {{ (course.combined_score * 100)|int }}%;"></div>
            </div>

            <!-- Details section -->
            <div class="row small">
              <div class="col-md-6">
                <div class="muted"><strong>Quick info</strong></div>
                <div><span class="muted">Exam:</span> {{ course.moed_a if course.moed_a else 'No exam' }}</div>
                <div><span class="muted">Lecturer:</span> {{ course.lecturer if course.lecturer else 'N/A' }}</div>
              </div>

              <div class="col-md-6">
                <div class="muted"><strong>Score breakdown</strong></div>
                <div><span class="muted">Semantic:</span> {{ "%.2f"|format(course.semantic_score) }}</div>
                <div><span class="muted">Combined:</span> {{ "%.2f"|format(course.combined_score) }}</div>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between mt-3">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('course_overview', course_id=course.ID) }}">
                View details
              </a>

              <button
                class="btn btn-sm btn-dark add-to-wishlist-btn"
                type="button"
                data-course-id="{{ course.ID }}"
                data-course-name="{{ course.title }}"
                data-course-points="{{ "%.1f"|format(course.credits) }}"
              >
                Add to wishlist
              </button>
            </div>

            <!-- Collapsible prerequisites -->
            {% if course.prerequisites %}
            <div class="mt-2">
              <button class="btn btn-sm btn-link p-0" type="button"
                      data-toggle="collapse" data-target="#prereq-{{ loop.index }}">
                Show prerequisites
              </button>
              <div id="prereq-{{ loop.index }}" class="collapse mt-2">
                <div class="alert alert-light small mb-0">
                  <strong>Prerequisites:</strong> {{ course.prerequisites|join(', ') }}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endfor %}

          {% if courses|length == 0 %}
          <div class="alert alert-light">
            No courses found matching your criteria. Try adjusting your filters or preferences.
          </div>
          {% endif %}
        </div>

        <!-- Show more button (initially hidden) -->
        <div id="showMoreContainer" class="text-center mt-3" style="display:none;">
          <button id="showMoreBtn" class="btn btn-outline-dark">
            Show more courses
          </button>
        </div>

      </div>

      <!-- Sidebar: Wishlist -->
      <div class="col-lg-4">
        <div class="feature-card p-3 sticky-top" style="top: 20px;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="muted small"><strong>Wishlist</strong></div>
            <div class="muted small">
              Total: <span id="wishlistCredits">0.0</span> pts
            </div>
          </div>

          <div id="wishlistEmpty" class="muted small mt-2">
            No courses yet. Click "Add to wishlist" to build your plan.
          </div>

          <div id="wishlistList" class="list-group mt-2" style="display:none;"></div>

          <div class="mt-3">
            <button id="clearWishlist" class="btn btn-sm btn-outline-secondary btn-block" type="button" disabled>
              Clear wishlist
            </button>
            <button id="exportPDF" class="btn btn-sm btn-dark btn-block mt-2" type="button" disabled>
              Export to PDF
            </button>
          </div>

          <!-- Ranking weights used -->
          <div class="mt-4">
            <div class="muted small mb-2"><strong>Ranking weights</strong></div>
            <div class="small">
              <div><span class="muted">Semantic:</span> {{ "%.2f"|format(weights.semantic) }}</div>
              <div><span class="muted">Credits:</span> {{ "%.2f"|format(weights.credits) }}</div>
              <div><span class="muted">Avg grade:</span> {{ "%.2f"|format(weights.avg_grade) }}</div>
              <div><span class="muted">Workload:</span> {{ "%.2f"|format(weights.workload_rating) }}</div>
              <div><span class="muted">General:</span> {{ "%.2f"|format(weights.general_rating) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-4 mb-4">
      <a class="btn btn-outline-secondary" href="{{ url_for('upload') }}">Back to upload</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Pagination / Show more logic ---
    const INITIAL_DISPLAY = 10;
    const INCREMENT = 10;
    let currentlyShowing = INITIAL_DISPLAY;

    const allCards = document.querySelectorAll('.course-card');
    const showMoreBtn = document.getElementById('showMoreBtn');
    const showMoreContainer = document.getElementById('showMoreContainer');
    const showAllBtn = document.getElementById('showAllBtn');

    function updateDisplay() {
      allCards.forEach((card, idx) => {
        card.style.display = idx < currentlyShowing ? 'block' : 'none';
      });

      // Show "show more" button if there are hidden cards
      if (currentlyShowing < allCards.length) {
        showMoreContainer.style.display = 'block';
      } else {
        showMoreContainer.style.display = 'none';
      }
    }

    showMoreBtn.addEventListener('click', () => {
      currentlyShowing += INCREMENT;
      updateDisplay();
    });

    showAllBtn.addEventListener('click', () => {
      currentlyShowing = allCards.length;
      updateDisplay();
    });

    // Initial display
    updateDisplay();

    // --- Wishlist functionality ---
    const wishlist = new Map();
    const wishlistList = document.getElementById("wishlistList");
    const wishlistEmpty = document.getElementById("wishlistEmpty");
    const wishlistCredits = document.getElementById("wishlistCredits");
    const clearBtn = document.getElementById("clearWishlist");
    const exportBtn = document.getElementById("exportPDF");

    function sumCredits() {
      let total = 0;
      wishlist.forEach(c => total += c.points);
      return total;
    }

    function renderWishlist() {
      const hasItems = wishlist.size > 0;

      wishlistEmpty.style.display = hasItems ? "none" : "block";
      wishlistList.style.display = hasItems ? "block" : "none";
      clearBtn.disabled = !hasItems;
      exportBtn.disabled = !hasItems;

      wishlistCredits.textContent = sumCredits().toFixed(1);

      wishlistList.innerHTML = "";
      wishlist.forEach((c) => {
        const row = document.createElement("div");
        row.className = "list-group-item d-flex justify-content-between align-items-center";

        row.innerHTML = `
          <div class="mr-2">
            <div><span class="kbd-pill">${c.id}</span> <strong>${escapeHtml(c.name)}</strong></div>
            <div class="muted small">${c.points.toFixed(1)} pts</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary">Remove</button>
        `;

        row.querySelector("button").onclick = () => {
          wishlist.delete(c.id);
          setButtonState(c.id, false);
          renderWishlist();
        };

        wishlistList.appendChild(row);
      });
    }

    function setButtonState(courseId, added) {
      document.querySelectorAll(`.add-to-wishlist-btn[data-course-id="${courseId}"]`).forEach(btn => {
        if (added) {
          btn.textContent = "Added";
          btn.classList.remove("btn-dark");
          btn.classList.add("btn-outline-secondary");
          btn.disabled = true;
        } else {
          btn.textContent = "Add to wishlist";
          btn.classList.add("btn-dark");
          btn.classList.remove("btn-outline-secondary");
          btn.disabled = false;
        }
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    document.querySelectorAll(".add-to-wishlist-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.courseId;
        const name = btn.dataset.courseName;
        const points = Number(btn.dataset.coursePoints);

        if (!wishlist.has(id)) {
          wishlist.set(id, { id, name, points });
          setButtonState(id, true);
          renderWishlist();
        }
      });
    });

    clearBtn.addEventListener("click", () => {
      wishlist.forEach((_, id) => setButtonState(id, false));
      wishlist.clear();
      renderWishlist();
    });

    exportBtn.addEventListener("click", () => {
      alert("PDF export feature coming soon!");
    });

    renderWishlist();
  </script>
</body>
</html>