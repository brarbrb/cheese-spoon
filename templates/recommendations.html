<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheeseSpoon â€” Recommendations</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body>
  <nav id="top-navbar" class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <span>CheeseSpoon</span>
        <img
          src="{{ url_for('static', filename='logo.png') }}"
          alt="CheeseSpoon"
          class="brand-logo"
        />
      </a>

      <button class="btn btn-outline-dark d-lg-none ml-auto mr-2" data-toggle="modal" data-target="#wishlistModal">
        <i class="fas fa-shopping-cart"></i> 
        <span class="badge badge-light" id="mobileWishlistCount">0</span>
      </button>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-navbar-supported-content">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="top-navbar-supported-content" class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto align-items-lg-center">
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2" href="{{ url_for('index') }}">Home</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2" href="{{ url_for('course_overview') }}">Course Overview</a>
          </li>
          <li class="nav-item d-none d-lg-block">
            <button class="btn btn-sm btn-dark" data-toggle="modal" data-target="#wishlistModal">
              <i class="fas fa-shopping-cart mr-1"></i> Wishlist
              <span class="badge badge-light ml-1" id="wishlistCount">0</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row">
      <div class="col-lg-8">
        <h4 class="mb-1">Course Recommendations</h4>
        <div class="muted small mb-3">
          All eligible courses ranked by your preferences
        </div>

        <div class="feature-card p-3 mb-3" style="height: auto !important; min-height: auto;">
          <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
              <div class="muted small mb-2"><strong>Applied Filters</strong></div>
              <div class="small">
                <span class="muted">Semester:</span> {{ filters.semester }}<br>
                <span class="muted">Completed:</span> {{ filters.completed_count }}<br>
                <span class="muted">Min credits:</span> {{ filters.min_credits }}
              </div>
            </div>
            <div class="text-right">
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload') }}">Edit preferences</a>
            </div>
          </div>
          {% if user_query %}
          <div class="alert alert-light small mt-3 mb-0">
            <strong>Your query:</strong> {{ user_query }}
          </div>
          {% endif %}
        </div>

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="muted small">Found <strong>{{ courses|length }}</strong> eligible courses</div>
          <button id="showAllBtn" class="btn btn-sm btn-outline-secondary">Show all</button>
        </div>

        <div id="coursesList">
          {% for course in courses %}
          <div class="feature-card rec-card p-3 mb-3 course-card" data-index="{{ loop.index0 }}" style="height: auto;">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center flex-wrap">
                  <span class="badge badge-secondary mr-2">#{{ loop.index }}</span>
                  <span class="kbd-pill mr-2">{{ course.ID }}</span>
                  <h5 class="mb-0">{{ course.title }}</h5>
                  <span class="muted small ml-2">({{ "%.1f"|format(course.credits) }} pts)</span>
                </div>
                <div class="mt-2 small">
                  <span class="muted">Avg grade:</span> {{ "%.0f"|format(course.avg_grade_all_sem) }}%
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">General rating:</span> {{ "%.1f"|format(course.general_rating) }}/5
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">Workload:</span> {{ "%.1f"|format(course.workload_rating) }}/5
                </div>
              </div>
              <div class="text-right ml-3">
                <div class="muted small">Combined Score</div>
                <div class="fit-score">{{ "%.0f"|format(course.combined_score * 100) }}%</div>
              </div>
            </div>

            <div class="fit-bar mt-2 mb-3">
              <div class="fit-bar-fill" style="width: {{ (course.combined_score * 100)|int }}%;"></div>
            </div>

            <div class="row small">
              <div class="col-md-6">
                <div class="muted"><strong>Quick info</strong></div>
                <div><span class="muted">Exam:</span> {{ course.moed_a if course.moed_a else 'No exam' }}</div>
                <div><span class="muted">Lecturer:</span> {{ course.lecturer if course.lecturer else 'N/A' }}</div>
              </div>
              <div class="col-md-6">
                <div class="muted"><strong>Score breakdown</strong></div>
                <div><span class="muted">Semantic:</span> {{ "%.2f"|format(course.semantic_score) }}</div>
                <div><span class="muted">Combined:</span> {{ "%.2f"|format(course.combined_score) }}</div>
              </div>
            </div>

            <div class="d-flex justify-content-between mt-3">
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('course_overview', course_id=course.ID) }}">
                View details
              </a>
              <button
                class="btn btn-sm btn-dark add-to-wishlist-btn"
                type="button"
                data-course-id="{{ course.ID }}"
                data-course-name="{{ course.title }}"
                data-course-points="{{ "%.1f"|format(course.credits) }}"
              >
                Add to wishlist
              </button>
            </div>

            {% if course.prerequisites %}
            <div class="mt-2">
              <button class="btn btn-sm btn-link p-0" type="button"
                      data-toggle="collapse" data-target="#prereq-{{ loop.index }}">
                Show prerequisites
              </button>
              <div id="prereq-{{ loop.index }}" class="collapse mt-2">
                <div class="alert alert-light small mb-0">
                  <strong>Prerequisites:</strong> {{ course.prerequisites|join(', ') }}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endfor %}

          {% if courses|length == 0 %}
          <div class="alert alert-light">No courses found matching your criteria.</div>
          {% endif %}
        </div>

        <div id="showMoreContainer" class="text-center mt-3" style="display:none;">
          <button id="showMoreBtn" class="btn btn-outline-dark">Show more courses</button>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="chat-container">
          <div class="chat-header d-flex justify-content-between align-items-center">
            <strong><i class="fas fa-robot mr-2"></i>CheeseSpoon Assistant</strong>
          </div>

          <div id="chatHistory" class="chat-messages">
            <div class="chat-message bot">
              Hi! I'm here to help. Ask me about course workloads, exam formats, or for comparison between two courses.
            </div>
          </div>

          <div class="chat-input-area">
            <div class="input-group">
              <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." aria-label="Ask a question">
              <div class="input-group-append">
                <button class="btn btn-dark" type="button" id="sendMessageBtn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            <div class="muted small mt-2 text-center" style="font-size: 0.7rem;">
              AI can make mistakes. Verify important info.
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="wishlistModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Wishlist</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="wishlistEmpty" class="text-center muted py-4">
            Your wishlist is empty.
          </div>
          <div id="wishlistItems" class="list-group"></div>
          <div class="mt-3 text-right">
             <strong class="mr-2">Total:</strong> <span id="modalTotalCredits">0.0</span> pts
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="clearWishlistBtn" disabled>Clear</button>
          <button type="button" class="btn btn-dark">Export PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Pagination Logic ---
    const INITIAL_DISPLAY = 10;
    const INCREMENT = 10;
    let currentlyShowing = INITIAL_DISPLAY;
    const allCards = document.querySelectorAll('.course-card');
    const showMoreBtn = document.getElementById('showMoreBtn');
    const showMoreContainer = document.getElementById('showMoreContainer');
    const showAllBtn = document.getElementById('showAllBtn');

    function updateDisplay() {
      allCards.forEach((card, idx) => {
        card.style.display = idx < currentlyShowing ? 'block' : 'none';
      });
      showMoreContainer.style.display = (currentlyShowing < allCards.length) ? 'block' : 'none';
    }

    if(showMoreBtn) showMoreBtn.addEventListener('click', () => {
      currentlyShowing += INCREMENT;
      updateDisplay();
    });

    if(showAllBtn) showAllBtn.addEventListener('click', () => {
      currentlyShowing = allCards.length;
      updateDisplay();
    });
    updateDisplay();

    // --- Wishlist Logic ---
    const wishlist = new Map();
    const wishlistCountBadge = document.getElementById("wishlistCount");
    const mobileWishlistCount = document.getElementById("mobileWishlistCount");
    const wishlistItemsContainer = document.getElementById("wishlistItems");
    const wishlistEmptyMsg = document.getElementById("wishlistEmpty");
    const modalTotalCredits = document.getElementById("modalTotalCredits");
    const clearWishlistBtn = document.getElementById("clearWishlistBtn");

    function updateWishlistUI() {
      const count = wishlist.size;
      wishlistCountBadge.innerText = count;
      mobileWishlistCount.innerText = count;

      wishlistItemsContainer.innerHTML = "";
      let totalPts = 0;
      
      if (count === 0) {
        wishlistEmptyMsg.style.display = 'block';
        clearWishlistBtn.disabled = true;
      } else {
        wishlistEmptyMsg.style.display = 'none';
        clearWishlistBtn.disabled = false;
        
        wishlist.forEach((item, id) => {
          totalPts += item.points;
          const el = document.createElement('div');
          el.className = "list-group-item d-flex justify-content-between align-items-center";
          el.innerHTML = `
            <div>
              <span class="kbd-pill mr-1">${item.id}</span> <strong>${item.name}</strong>
              <div class="small muted">${item.points} pts</div>
            </div>
            <button class="btn btn-sm text-danger remove-item-btn" data-id="${id}">&times;</button>
          `;
          wishlistItemsContainer.appendChild(el);
        });

        document.querySelectorAll('.remove-item-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            removeFromWishlist(id);
          });
        });
      }
      modalTotalCredits.innerText = totalPts.toFixed(1);
    }

    function toggleButtonState(id, isAdded) {
       document.querySelectorAll(`.add-to-wishlist-btn[data-course-id="${id}"]`).forEach(btn => {
         if (isAdded) {
           btn.innerHTML = '<i class="fas fa-check"></i> Added';
           btn.classList.remove('btn-dark');
           btn.classList.add('btn-outline-success');
           btn.disabled = true;
         } else {
           btn.innerHTML = 'Add to wishlist';
           btn.classList.add('btn-dark');
           btn.classList.remove('btn-outline-success');
           btn.disabled = false;
         }
       });
    }

    function addToWishlist(id, name, points) {
       if(!wishlist.has(id)) {
         wishlist.set(id, { id, name, points });
         updateWishlistUI();
         toggleButtonState(id, true);
         
         // [DELETED] Toast popup trigger was here
       }
    }

    function removeFromWishlist(id) {
      if(wishlist.has(id)) {
        wishlist.delete(id);
        updateWishlistUI();
        toggleButtonState(id, false);
      }
    }

    document.querySelectorAll(".add-to-wishlist-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        addToWishlist(
          btn.dataset.courseId,
          btn.dataset.courseName,
          parseFloat(btn.dataset.coursePoints)
        );
      });
    });

    clearWishlistBtn.addEventListener('click', () => {
      wishlist.forEach((_, id) => toggleButtonState(id, false));
      wishlist.clear();
      updateWishlistUI();
    });

    // --- Chat Logic ---
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendMessageBtn');
    const chatHistory = document.getElementById('chatHistory');

    function appendMessage(text, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `chat-message ${sender}`;
      msgDiv.innerText = text;
      chatHistory.appendChild(msgDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function handleSend() {
      const text = chatInput.value.trim();
      if(!text) return;
      appendMessage(text, 'user');
      chatInput.value = '';
      setTimeout(() => {
        appendMessage("I'm just a demo interface right now. I'll be connected to a real LLM soon!", 'bot');
      }, 800);
    }

    sendBtn.addEventListener('click', handleSend);
    chatInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') handleSend();
    });
  </script>
</body>
</html>