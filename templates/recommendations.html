<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheeseSpoon â€” Recommendations</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body>
  <nav id="top-navbar" class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <span>CheeseSpoon</span>
        <img
          src="{{ url_for('static', filename='logo.png') }}"
          alt="CheeseSpoon"
          class="brand-logo"
        />
      </a>

      <button class="btn btn-outline-dark d-lg-none ml-auto mr-2" data-toggle="modal" data-target="#wishlistModal">
        <i class="fas fa-shopping-cart"></i> 
        <span class="badge badge-light" id="mobileWishlistCount">0</span>
      </button>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-navbar-supported-content">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div id="top-navbar-supported-content" class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto align-items-lg-center">
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2" href="{{ url_for('index') }}">Home</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-sm btn-outline-secondary mr-lg-2" href="{{ url_for('course_overview') }}">Course Overview</a>
          </li>
          <li class="nav-item d-none d-lg-block">
            <button class="btn btn-sm btn-dark" data-toggle="modal" data-target="#wishlistModal">
              <i class="fas fa-shopping-cart mr-1"></i> Wishlist
              <span class="badge badge-light ml-1" id="wishlistCount">0</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="mb-3">
        <a href="{{ url_for('filters') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left mr-1"></i> Back to Filters
        </a>
    </div>

    <div class="row">
      <div class="col-lg-7">
        <h4 class="mb-1">Course Recommendations</h4>
        <div class="muted small mb-3">
          All eligible courses ranked by your preferences
        </div>

        <div class="feature-card p-3 mb-3" style="height: auto !important;">
          <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
              <div class="muted small mb-2"><strong>Current Configuration</strong></div>
              <div class="small">
                <span class="badge badge-light border">{{ filters.semester }}</span>
                {% if user_query %}
                <span class="badge badge-info text-white border" title="{{ user_query }}">Has custom query</span>
                {% endif %}
                {% if filters.no_exam == "Yes" %}
                <span class="badge badge-success border">No Exams</span>
                {% endif %}
              </div>
            </div>
            <div class="text-right">
              <button class="btn btn-sm btn-outline-primary" type="button" data-toggle="collapse" data-target="#editFiltersCollapse" aria-expanded="false" aria-controls="editFiltersCollapse">
                <i class="fas fa-sliders-h mr-1"></i> Modify & Rerank
              </button>
            </div>
          </div>

          <div class="collapse mt-3" id="editFiltersCollapse">
            <hr>
            <form action="{{ url_for('filters') }}" method="POST">
                <input type="hidden" name="semester" value="{{ filters.semester }}">
                
                <div class="form-group">
                    <label class="small font-weight-bold">Refine your prompt</label>
                    <textarea class="form-control form-control-sm" name="preferences_text" rows="2" placeholder="e.g. I want easy courses with Python...">{{ user_query }}</textarea>
                </div>

                <div class="form-row">
                    <div class="col-6">
                        <div class="custom-control custom-checkbox small pt-2">
                            <input type="checkbox" class="custom-control-input" id="no_exam" name="no_exam" value="true" {% if filters.no_exam == "Yes" %}checked{% endif %}>
                            <label class="custom-control-label" for="no_exam">No Exams</label>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="small muted mb-0">Min Credits</label>
                        <input type="number" class="form-control form-control-sm" name="min_credits" value="{{ filters.min_credits }}" step="0.5" min="0">
                    </div>
                </div>

                <div class="mt-3">
                    <label class="small font-weight-bold mb-2">Adjust Weights (0.0 - 1.0)</label>
                    
                    <div class="d-flex align-items-center mb-1">
                        <small class="col-4 p-0">Semantic Match</small>
                        <input type="range" class="custom-range col-6" name="semantic_weight" min="0" max="1" step="0.1" value="{{ weights.semantic }}">
                    </div>

                    <div class="d-flex align-items-center mb-1">
                        <small class="col-4 p-0">High Avg Grade</small>
                        <input type="range" class="custom-range col-6" name="avg_grade_weight" min="0" max="1" step="0.1" value="{{ weights.avg_grade }}">
                    </div>

                    <div class="d-flex align-items-center mb-1">
                        <small class="col-4 p-0">Low Workload</small>
                        <input type="range" class="custom-range col-6" name="workload_rating_weight" min="0" max="1" step="0.1" value="{{ weights.workload_rating }}">
                    </div>
                    
                    <input type="hidden" name="credits_weight" value="{{ weights.credits }}">
                    <input type="hidden" name="general_rating_weight" value="{{ weights.general_rating }}">
                </div>

                <div class="text-right mt-3">
                    <button type="submit" class="btn btn-dark btn-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Rerank Courses
                    </button>
                </div>
            </form>
          </div>
        </div>

        <div class="mb-2">
          <div class="muted small">Found <strong>{{ courses|length }}</strong> eligible courses</div>
        </div>

        <div id="coursesList">
          {% for course in courses %}
          <div class="feature-card rec-card p-3 mb-3 course-card" data-index="{{ loop.index0 }}" style="height: auto;">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center flex-wrap">
                  <span class="badge badge-secondary mr-2">#{{ loop.index }}</span>
                  <h5 class="mb-0">{{ course.title }}</h5>
                  <span class="muted small ml-2">({{ "%.1f"|format(course.credits) }} pts)</span>
                </div>
                <div class="mt-2 small">
                  <span class="muted">Avg Grade:</span> {{ "%.0f"|format(course.avg_grade_all_sem) }}
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">General:</span> {{ "%.1f"|format(course.general_rating) }}/5
                  <span class="ml-2 muted">|</span>
                  <span class="ml-2 muted">Workload:</span> {{ "%.1f"|format(course.workload_rating) }}/5
                </div>
              </div>
              <div class="text-right ml-3">
                <div class="muted small">Match</div>
                <div class="fit-score">{{ "%.0f"|format(course.combined_score * 100) }}%</div>
              </div>
            </div>

            <div class="fit-bar mt-2 mb-3">
              <div class="fit-bar-fill" style="width: {{ (course.combined_score * 100)|int }}%;"></div>
            </div>

            {% if course.moed_a %}
            <div class="row small mb-2">
              <div class="col-6">
                <div class="p-2 border rounded bg-light">
                    <div class="muted font-weight-bold">Moed A</div>
                    <div>{{ course.moed_a }}</div>
                </div>
              </div>
              <div class="col-6">
                <div class="p-2 border rounded bg-light">
                    <div class="muted font-weight-bold">Moed B</div>
                    <div>{{ course.moed_b if course.moed_b else 'TBD' }}</div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="mb-2">
                <div class="p-2 border rounded bg-light text-center">
                    <!-- <div class="muted font-weight-bold text-success">
                        <i class="fas fa-check-circle mr-1"></i> No Exam
                    </div> -->
                    <div class="small text-muted">No Exam. Grade based on projects/assignments</div>
                </div>
            </div>
            {% endif %}

            <div class="mt-2">
                <div class="small font-weight-bold mb-1">Course Highlights</div>
                <div class="ai-description-placeholder small">
                    Brief course description / main topics will appear here...
                </div>
            </div>

            <div class="d-flex justify-content-between mt-3 align-items-center">
              <button class="btn btn-sm btn-link pl-0 text-secondary" 
                      data-toggle="modal" 
                      data-target="#courseDetailsModal"
                      data-title="{{ course.title }}"
                      data-id="{{ course.ID }}">
                 <i class="fas fa-expand mr-1"></i> Full Details
              </button>
              
              <button
                class="btn btn-sm btn-dark add-to-wishlist-btn"
                type="button"
                data-course-id="{{ course.ID }}"
                data-course-name="{{ course.title }}"
                data-course-points="{{ "%.1f"|format(course.credits) }}"
              >
                Add to wishlist
              </button>
            </div>
          </div>
          {% endfor %}

          {% if courses|length == 0 %}
          <div class="alert alert-light">No courses found matching your criteria. Try adjusting the filters.</div>
          {% endif %}
        </div>

        <div id="showMoreContainer" class="text-center mt-3" style="display:none;">
          <button id="showMoreBtn" class="btn btn-outline-dark">Show more courses</button>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="chat-container">
          <div class="chat-header d-flex justify-content-between align-items-center">
            <strong><i class="fas fa-robot mr-2"></i>CheeseSpoon Assistant</strong>
          </div>

          <div id="chatHistory" class="chat-messages">
          <div class="chat-message bot">
            ×©×œ×•×! ×× ×™ ×›××Ÿ ×›×“×™ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×¡×¤×¦×™×¤×™×•×ª ×¢×œ ×§×•×¨×¡×™× ğŸ“<br><br>
            ××ª×” ×™×›×•×œ ×œ×©××•×œ ××•×ª×™:<br>
            â€¢ "××” ××•××¨×™× ×¢×œ ×¢×•××¡ ×”×¢×‘×•×“×” ×‘×§×•×¨×¡ X?"<br>
            â€¢ "×”×× ×™×© ××‘×—×Ÿ ×‘×§×•×¨×¡ Y?"<br>
            â€¢ "××” ×”×”×‘×“×œ ×‘×§×•×©×™ ×‘×™×Ÿ ×§×•×¨×¡ A ×œ×§×•×¨×¡ B?"<br>
            â€¢ "××™×š ×”××¨×¦×” Z?"<br>
            â€¢ "×›××” ×–××Ÿ ×œ×•×§×— ×œ×”×›×™×Ÿ ×œ××‘×—×Ÿ?"
          </div>
        </div>

          <div class="chat-input-area">
            <div class="input-group">
              <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." aria-label="Ask a question">
              <div class="input-group-append">
                <button class="btn btn-dark" type="button" id="sendMessageBtn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            <div class="muted small mt-2 text-center" style="font-size: 0.7rem;">
              AI can make mistakes. Verify important info.
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="wishlistModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Wishlist</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="wishlistEmpty" class="text-center muted py-4">
            Your wishlist is empty.
          </div>
          <div id="wishlistItems" class="list-group"></div>
          <div class="mt-3 text-right">
             <strong class="mr-2">Total:</strong> <span id="modalTotalCredits">0.0</span> pts
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="clearWishlistBtn" disabled>Clear</button>
          <button type="button" class="btn btn-dark">Export PDF</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="courseDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailsModalTitle">Course Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="text-center py-5 muted">
            <i class="fas fa-hammer fa-2x mb-3"></i><br>
            Course summary and syllabus details will appear here.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Pagination Logic ---
    const INITIAL_DISPLAY = 10;
    const INCREMENT = 10;
    let currentlyShowing = INITIAL_DISPLAY;
    const allCards = document.querySelectorAll('.course-card');
    const showMoreBtn = document.getElementById('showMoreBtn');
    const showMoreContainer = document.getElementById('showMoreContainer');

    function updateDisplay() {
      allCards.forEach((card, idx) => {
        card.style.display = idx < currentlyShowing ? 'block' : 'none';
      });
      if (showMoreContainer) {
          showMoreContainer.style.display = (currentlyShowing < allCards.length) ? 'block' : 'none';
      }
    }

    if(showMoreBtn) showMoreBtn.addEventListener('click', () => {
      currentlyShowing += INCREMENT;
      updateDisplay();
    });
    
    updateDisplay();

    // --- Details Modal Logic ---
    $('#courseDetailsModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var title = button.data('title');
      var id = button.data('id');
      var modal = $(this);
      modal.find('.modal-title').text(title + ' (' + id + ')');
      // Later you can fetch content via AJAX here using the ID
    });

    // --- Wishlist Logic ---
    const wishlist = new Map();
    const wishlistCountBadge = document.getElementById("wishlistCount");
    const mobileWishlistCount = document.getElementById("mobileWishlistCount");
    const wishlistItemsContainer = document.getElementById("wishlistItems");
    const wishlistEmptyMsg = document.getElementById("wishlistEmpty");
    const modalTotalCredits = document.getElementById("modalTotalCredits");
    const clearWishlistBtn = document.getElementById("clearWishlistBtn");

    function updateWishlistUI() {
      const count = wishlist.size;
      wishlistCountBadge.innerText = count;
      mobileWishlistCount.innerText = count;

      wishlistItemsContainer.innerHTML = "";
      let totalPts = 0;
      
      if (count === 0) {
        wishlistEmptyMsg.style.display = 'block';
        clearWishlistBtn.disabled = true;
      } else {
        wishlistEmptyMsg.style.display = 'none';
        clearWishlistBtn.disabled = false;
        
        wishlist.forEach((item, id) => {
          totalPts += item.points;
          const el = document.createElement('div');
          el.className = "list-group-item d-flex justify-content-between align-items-center";
          el.innerHTML = `
            <div>
              <span class="kbd-pill mr-1">${item.id}</span> <strong>${item.name}</strong>
              <div class="small muted">${item.points} pts</div>
            </div>
            <button class="btn btn-sm text-danger remove-item-btn" data-id="${id}">&times;</button>
          `;
          wishlistItemsContainer.appendChild(el);
        });

        document.querySelectorAll('.remove-item-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.closest('button').dataset.id;
            removeFromWishlist(id);
          });
        });
      }
      modalTotalCredits.innerText = totalPts.toFixed(1);
    }

    function toggleButtonState(id, isAdded) {
       document.querySelectorAll(`.add-to-wishlist-btn[data-course-id="${id}"]`).forEach(btn => {
         if (isAdded) {
           btn.innerHTML = '<i class="fas fa-check"></i> Added';
           btn.classList.remove('btn-dark');
           btn.classList.add('btn-outline-success');
           btn.disabled = true;
         } else {
           btn.innerHTML = 'Add to wishlist';
           btn.classList.add('btn-dark');
           btn.classList.remove('btn-outline-success');
           btn.disabled = false;
         }
       });
    }

    function addToWishlist(id, name, points) {
       if(!wishlist.has(id)) {
         wishlist.set(id, { id, name, points });
         updateWishlistUI();
         toggleButtonState(id, true);
       }
    }

    function removeFromWishlist(id) {
      if(wishlist.has(id)) {
        wishlist.delete(id);
        updateWishlistUI();
        toggleButtonState(id, false);
      }
    }

    document.querySelectorAll(".add-to-wishlist-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        addToWishlist(
          btn.dataset.courseId,
          btn.dataset.courseName,
          parseFloat(btn.dataset.coursePoints)
        );
      });
    });

    clearWishlistBtn.addEventListener('click', () => {
      wishlist.forEach((_, id) => toggleButtonState(id, false));
      wishlist.clear();
      updateWishlistUI();
    });

    // --- Chat Logic ---
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendMessageBtn');
    const chatHistory = document.getElementById('chatHistory');
    let conversationHistory = [];

    function appendMessage(text, sender, sources = null) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `chat-message ${sender}`;
      msgDiv.innerText = text;
      chatHistory.appendChild(msgDiv);

      // Add sources if provided
      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'chat-sources small muted mt-2';
        sourcesDiv.innerHTML = '<strong>××§×•×¨×•×ª:</strong><br>' +
          sources.map(s => `â€¢ ${s.course_title} (${s.course_id}) - ${s.relevance_score}%`).join('<br>');
        chatHistory.appendChild(sourcesDiv);
      }

      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function showTypingIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'chat-message bot typing-indicator';
      indicator.id = 'typing';
      indicator.innerHTML = '<span></span><span></span><span></span>';
      chatHistory.appendChild(indicator);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typing');
      if (indicator) indicator.remove();
    }

    async function handleSend() {
      const text = chatInput.value.trim();
      if(!text) return;

      // Disable input while processing
      chatInput.disabled = true;
      sendBtn.disabled = true;

      appendMessage(text, 'user');
      conversationHistory.push({ role: 'user', content: text });
      chatInput.value = '';

      showTypingIndicator();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: text,
            history: conversationHistory.slice(-6) // Keep last 3 exchanges
          })
        });

        const data = await response.json();

        removeTypingIndicator();

        if (data.success) {
          appendMessage(data.response, 'bot', data.sources);
          conversationHistory.push({ role: 'assistant', content: data.response });
        } else {
          appendMessage('××¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘.', 'bot');
        }

      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        appendMessage('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª. ×× × × ×¡×” ×©×•×‘.', 'bot');
      } finally {
        // Re-enable input
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.focus();
      }
    }

    if (sendBtn) sendBtn.addEventListener('click', handleSend);
    if (chatInput) chatInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // Load course summaries on page load
    document.addEventListener('DOMContentLoaded', async () => {
      const coursePlaceholders = document.querySelectorAll('.ai-description-placeholder');

      coursePlaceholders.forEach(async (placeholder, index) => {
        const card = placeholder.closest('.course-card');
        const courseTitle = card.querySelector('h5').innerText;

        // Extract course ID from title (assuming format like "123456 - Course Name")
        const idMatch = courseTitle.match(/(\d{6,8})/);
        if (!idMatch) return;

        const courseId = idMatch[1];

        try {
          const response = await fetch(`/api/course-summary/${courseId}`);
          const data = await response.json();

          if (data.success) {
            placeholder.innerText = data.summary;
            placeholder.classList.remove('text-muted');
          }
        } catch (error) {
          console.error(`Error loading summary for ${courseId}:`, error);
        }
      });
    });
  </script>
</body>
</html>