<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheeseSpoon — Recommendations</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body>
  <nav id="top-navbar" class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
        <span>CheeseSpoon</span>
        <img
          src="{{ url_for('static', filename='logo.png') }}"
          alt="CheeseSpoon"
          class="brand-logo"
        />
      </a>

      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#top-navbar-supported-content">
        <span class="navbar-toggler-icon"></span>
      </button>


<div id="top-navbar-supported-content" class="collapse navbar-collapse">
  <ul class="navbar-nav ml-auto align-items-lg-center">

    <li class="nav-item">
      <a class="btn btn-sm btn-outline-secondary mr-lg-2"
         href="{{ url_for('index') }}">
        Home
      </a>
    </li>

    <li class="nav-item">
      <a class="btn btn-sm btn-outline-secondary mr-lg-2"
         href="{{ url_for('upload') }}">
        Course Overview
      </a>
    </li>

  </ul>
</div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row">
      <div class="col-lg-8">
        <h4 class="mb-1">Recommendations — What should I take?</h4>
        <div class="muted small mb-3">
          Step 3/3 — Best fitted courses for you. 
        </div>
      </div>

      <div class="col-lg-4">
        <div class="feature-card p-3">
          <div class="muted small mb-2"><strong>Your preferences</strong></div>

          {% for chip in prefs.chips %}
            <span class="badge badge-dark pref-chip-static">{{ chip }}</span>
          {% endfor %}

          <div class="muted small mt-3">
            {{ prefs.free_text }}
          </div>

          <div class="mt-3">
            <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('upload') }}">Edit preferences</a>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col-lg-8">
        <!-- Recommendation cards -->
        {% for r in recs %}
        <!-- <div class="feature-card p-3 mb-3"> -->
            <div class="feature-card rec-card p-3 mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="d-flex align-items-center flex-wrap">
                <span class="kbd-pill mr-2">{{ r.id }}</span>
                <h5 class="mb-0">{{ r.name }}</h5>
                <span class="muted small ml-2">(<span class="course-points">{{ "%.1f"|format(r.points) }}</span> pts)</span>
              </div>

              <div class="mt-2">
                {% for t in r.tags %}
                  <span class="badge badge-light border mr-1">{{ t }}</span>
                {% endfor %}
              </div>
            </div>

            <div class="text-right">
              <div class="muted small">Fit score</div>
              <div class="fit-score">{{ r.fit }}%</div>
            </div>
          </div>

          <!-- Fit bar -->
          <div class="fit-bar mt-2 mb-3">
            <div class="fit-bar-fill" style="width: {{ r.fit }}%;"></div>
          </div>

          <div class="row">
            <div class="col-md-8">
              <div class="muted small mb-1"><strong>Why recommended</strong></div>
              <ul class="mb-0 small">
                {% for w in r.why %}
                  <li>{{ w }}</li>
                {% endfor %}
              </ul>
            </div>
            <div class="col-md-4 mt-3 mt-md-0">
              <div class="muted small mb-1"><strong>In short</strong></div>
              <div class="small">
                <div><span class="muted">Format:</span> {{ r.meta.format }}</div>
                <div><span class="muted">Workload:</span> {{ r.meta.workload }}</div>
                <div><span class="muted">Lecturer:</span> {{ r.meta.lecturer }}</div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#details-{{ loop.index }}">
              Details
            </button>

            <!-- Add-to-wishlist button wired to JS -->
            <button
              class="btn btn-sm btn-dark add-to-wishlist-btn"
              type="button"
              data-course-id="{{ r.id }}"
              data-course-name="{{ r.name }}"
              data-course-points="{{ "%.1f"|format(r.points) }}"
            >
              Add to wishlist
            </button>
          </div>

          <div id="details-{{ loop.index }}" class="collapse mt-3">
            <div class="alert alert-light small mb-0">
              <strong>Explainability mock:</strong> Here we will show a review summary, hours of different sudy groups, representative quotes,
              workload distribution, and “bottleneck unlocks” graph (Not showed here since it's a mock).
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="col-lg-4">
        <!-- Wishlist Cart (replaces "How we rank") -->
        <div class="feature-card p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="muted small"><strong>Wishlist</strong></div>
            <div class="muted small">
              Total: <span id="wishlistCredits">0.0</span> pts
            </div>
          </div>

          <div id="wishlistEmpty" class="muted small mt-2">
            No courses yet. Click “Add to wishlist” to build your plan.
          </div>

          <div id="wishlistList" class="list-group mt-2" style="display:none;"></div>

          <div class="mt-3">
            <button id="clearWishlist" class="btn btn-sm btn-outline-secondary btn-block" type="button" disabled>
              Clear wishlist
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-2 mb-4">
      <a class="btn btn-outline-secondary" href="{{ url_for('eligibility') }}">Back</a>
      <a class="btn btn-dark" href="#">Export to PDF</a>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Wishlist Cart (client-side mock, no backend) ---
    const wishlist = new Map(); // id -> {id, name, points}

    const wishlistList = document.getElementById("wishlistList");
    const wishlistEmpty = document.getElementById("wishlistEmpty");
    const wishlistCredits = document.getElementById("wishlistCredits");
    const clearBtn = document.getElementById("clearWishlist");
    const badge = document.getElementById("wishlistBadge");

    function sumCredits() {
      let total = 0;
      wishlist.forEach(c => total += c.points);
      return total;
    }

    function updateBadge() {
      const n = wishlist.size;
      if (!badge) return;
      if (n <= 0) {
        badge.style.display = "none";
      } else {
        badge.style.display = "inline-block";
        badge.textContent = String(n);
      }
    }

    function renderWishlist() {
      const hasItems = wishlist.size > 0;

      wishlistEmpty.style.display = hasItems ? "none" : "block";
      wishlistList.style.display = hasItems ? "block" : "none";
      clearBtn.disabled = !hasItems;

      wishlistCredits.textContent = sumCredits().toFixed(1);
      updateBadge();

      wishlistList.innerHTML = "";
      wishlist.forEach((c) => {
        const row = document.createElement("div");
        row.className = "list-group-item d-flex justify-content-between align-items-center";

        row.innerHTML = `
          <div class="mr-2">
            <div><span class="kbd-pill">${c.id}</span> <strong>${escapeHtml(c.name)}</strong></div>
            <div class="muted small">${c.points.toFixed(1)} pts</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary">Remove</button>
        `;

        row.querySelector("button").onclick = () => {
          wishlist.delete(c.id);
          setButtonState(c.id, false);
          renderWishlist();
        };

        wishlistList.appendChild(row);
      });
    }

    function setButtonState(courseId, added) {
      document.querySelectorAll(`.add-to-wishlist-btn[data-course-id="${courseId}"]`).forEach(btn => {
        if (added) {
          btn.textContent = "Added";
          btn.classList.remove("btn-dark");
          btn.classList.add("btn-outline-secondary");
          btn.disabled = true;
        } else {
          btn.textContent = "Add to wishlist";
          btn.classList.add("btn-dark");
          btn.classList.remove("btn-outline-secondary");
          btn.disabled = false;
        }
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    document.querySelectorAll(".add-to-wishlist-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.courseId;
        const name = btn.dataset.courseName;
        const points = Number(btn.dataset.coursePoints);

        if (!wishlist.has(id)) {
          wishlist.set(id, { id, name, points });
          setButtonState(id, true);
          renderWishlist();
        }
      });
    });

    clearBtn.addEventListener("click", () => {
      wishlist.forEach((_, id) => setButtonState(id, false));
      wishlist.clear();
      renderWishlist();
    });

    renderWishlist();
  </script>
</body>
</html>
